<!DOCTYPE html>
<html>
<head>
  <!--
    Base configuration for DWCE Time Tracker Web App
    This file is automatically generated by Flutter.
    
    For production deployment, ensure your .env file contains:
    SUPABASE_URL=your_supabase_url
    SUPABASE_ANON_KEY=your_anon_key
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="DWCE Time Tracker - Employee time tracking and management system">
  <title>DWCE Time Tracker</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#0175C2">
  
  <!-- Noto Sans Symbols: preconnect + stylesheet + preload so font is cached before Flutter requests it (avoids "Failed to fetch" when Flutter's fallback loads symbols) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols&display=swap" rel="stylesheet">
  <link rel="preload" href="https://fonts.gstatic.com/s/notosanssymbols/v43/rP2up3q65FkAtHfwd-eIS2brbDN6gxP34F9jRRCe4W3gfQ8gb_VFRkzrbQ.woff2" as="font" type="font/woff2" crossorigin>
  
  <!-- Flutter Web Configuration -->
  <script>
    // Flutter web configuration
    // Environment variables are loaded from .env file via flutter_dotenv
    // No need to hardcode credentials here for security
    
    // Google Maps API lazy loading - only load when needed
    // This function can be called from Dart/Flutter when a screen needs the Google Maps widget
    window.loadGoogleMapsApi = function() {
      return new Promise(function(resolve, reject) {
        // Check if already loaded
        if (window.google && window.google.maps) {
          console.log('‚úÖ Google Maps API already loaded');
          resolve();
          return;
        }
        
        // Check if already loading
        if (window.googleMapsLoading) {
          // Wait for existing load to complete
          window.googleMapsLoading.then(resolve).catch(reject);
          return;
        }
        
        // Function to load Google Maps API script
        // Note: loading=async is recommended by Google but requires importLibrary() usage;
        // google_maps_flutter_web uses the classic API, so we load without it to avoid breakage.
        // Marker deprecation (Feb 2024): google.maps.Marker is deprecated; use google.maps.marker.AdvancedMarkerElement.
        // The Flutter plugin google_maps_flutter_web still uses Marker. We load libraries=marker for future migration.
        // See https://developers.google.com/maps/documentation/javascript/advanced-markers/migration
        function loadGoogleMapsScript(apiKey) {
          var script = document.createElement('script');
          script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&libraries=marker';
          script.async = true;
          script.defer = true;
          script.onload = function() {
            console.log('‚úÖ Google Maps API script loaded');
            window.googleMapsLoading = null;
            resolve();
          };
          script.onerror = function() {
            console.error('‚ùå Failed to load Google Maps API');
            window.googleMapsLoading = null;
            reject(new Error('Failed to load Google Maps API script'));
          };
          document.head.appendChild(script);
          console.log('üì§ Google Maps API script injected');
        }
        
        // Try to get API key from Edge Function
        function fetchApiKey() {
          // Try to get Supabase URL from localStorage (set by Flutter after .env loads)
          var url = localStorage.getItem('SUPABASE_URL') || '';
          
          if (!url) {
            // Listen for the custom event from Flutter
            window.addEventListener('supabaseReady', function(event) {
              var detail = event.detail || {};
              if (detail.url) {
                localStorage.setItem('SUPABASE_URL', detail.url);
              }
              if (detail.anonKey) {
                localStorage.setItem('SUPABASE_ANON_KEY', detail.anonKey);
              }
              if (detail.url) {
                fetchApiKey();
              }
            }, { once: true });
            // Retry after a delay
            setTimeout(fetchApiKey, 1000);
            return;
          }
          
          url = url.replace(/\/$/, '');
          if (!url) {
            console.warn('‚ö†Ô∏è Supabase URL not available, retrying...');
            setTimeout(fetchApiKey, 1000);
            return;
          }
          
          var edgeFunctionUrl = url + '/functions/v1/get_google_maps_api_key';
          console.log('üîç Fetching Google Maps API key from:', edgeFunctionUrl);
          
          // Get anon key from localStorage if available
          var anonKey = localStorage.getItem('SUPABASE_ANON_KEY') || '';
          
          var headers = {
            'Accept': 'application/json',
          };
          
          // Add apikey header if available (required for Supabase Edge Functions)
          if (anonKey) {
            headers['apikey'] = anonKey;
            headers['Authorization'] = 'Bearer ' + anonKey;
          }
          
          // Mark as loading
          window.googleMapsLoading = fetch(edgeFunctionUrl, {
            method: 'GET',
            mode: 'cors',
            headers: headers
          })
          .then(function(response) {
            if (!response.ok) {
              return response.text().then(function(text) {
                throw new Error('Failed to fetch API key: ' + response.status + ' - ' + text);
              });
            }
            return response.json();
          })
          .then(function(data) {
            if (data.success && data.apiKey) {
              console.log('‚úÖ Google Maps API key retrieved successfully');
              loadGoogleMapsScript(data.apiKey);
            } else if (data.apiKey) {
              // Handle case where response might not have 'success' field
              console.log('‚úÖ Google Maps API key retrieved (no success field)');
              loadGoogleMapsScript(data.apiKey);
            } else {
              throw new Error('Failed to get API key: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(function(error) {
            console.error('‚ùå Error fetching Google Maps API key:', error);
            window.googleMapsLoading = null;
            reject(error);
          });
        }
        
        // Start fetching
        fetchApiKey();
      });
    };
  </script>
  
  <!-- Flutter Web Engine -->
  <script defer src="main.dart.js" type="application/javascript"></script>
</head>
<body>
  <!-- Loading indicator (optional) -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">
    <div style="text-align: center;">
      <div style="font-size: 24px; margin-bottom: 16px;">Loading DWCE Time Tracker...</div>
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0175C2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    </div>
  </div>
  
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    body {
      margin: 0;
      padding: 0;
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 99999;
      pointer-events: none;
    }
    
    /* Hide loading when Flutter app loads */
    .flutter-loaded #loading {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* Ensure body is visible when loading is hidden */
    .flutter-loaded {
      overflow: auto;
    }
  </style>
  
  <script>
    // Function to hide loading screen (multiple methods)
    function hideLoading() {
      if (document.body.classList.contains('flutter-loaded')) {
        return; // Already hidden
      }
      
      document.body.classList.add('flutter-loaded');
      
      // Also directly hide/remove the element as backup
      var loadingDiv = document.getElementById('loading');
      if (loadingDiv) {
        loadingDiv.style.display = 'none';
        // Optionally remove it completely after a delay
        setTimeout(function() {
          if (loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
          }
        }, 500);
      }
      
      console.log('Loading screen hidden');
    }
    
    // Aggressive detection - check immediately and frequently
    function checkFlutterReady() {
      // Check for any Flutter-rendered content
      var hasFlutterContent = false;
      
      // Method 1: Check for Flutter custom elements
      if (document.querySelector('flt-scene-host, flt-glass-pane, canvas')) {
        hasFlutterContent = true;
      }
      
      // Method 2: Check for canvas elements (Flutter renders to canvas)
      var canvases = document.querySelectorAll('canvas');
      if (canvases.length > 0) {
        hasFlutterContent = true;
      }
      
      // Method 3: Check body for non-script, non-loading elements
      var bodyChildren = Array.from(document.body.children);
      var nonLoadingElements = bodyChildren.filter(function(child) {
        return child.id !== 'loading' && 
               child.tagName.toLowerCase() !== 'script' &&
               child.tagName.toLowerCase() !== 'style';
      });
      if (nonLoadingElements.length > 0) {
        hasFlutterContent = true;
      }
      
      // Method 4: Check if main.dart.js has loaded and executed
      if (window._flutter && window._flutter.loader) {
        hasFlutterContent = true;
      }
      
      return hasFlutterContent;
    }
    
    // Start checking immediately when script loads
    var checkInterval = setInterval(function() {
      if (checkFlutterReady()) {
        clearInterval(checkInterval);
        // Wait a tiny bit for rendering to complete
        setTimeout(hideLoading, 200);
      }
    }, 50); // Check every 50ms
    
    // Listen for flutter-first-frame event
    window.addEventListener('flutter-first-frame', function() {
      clearInterval(checkInterval);
      hideLoading();
    });
    
    // Use MutationObserver for immediate detection
    var observer = new MutationObserver(function(mutations) {
      if (checkFlutterReady()) {
        clearInterval(checkInterval);
        observer.disconnect();
        setTimeout(hideLoading, 100);
      }
    });
    
    // Start observing immediately
    if (document.body) {
      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: false
      });
    } else {
      // Wait for body to exist
      document.addEventListener('DOMContentLoaded', function() {
        observer.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: false
        });
      });
    }
    
    // Fallback: Force hide after 3 seconds (app should be loaded by then)
    setTimeout(function() {
      clearInterval(checkInterval);
      observer.disconnect();
      console.log('Force hiding loading screen after 3 seconds');
      hideLoading();
    }, 3000);
    
    // Additional fallback: Hide when window loads
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (!document.body.classList.contains('flutter-loaded')) {
          console.log('Hiding loading screen on window load');
          hideLoading();
        }
      }, 1000);
    });
  </script>
</body>
</html>
